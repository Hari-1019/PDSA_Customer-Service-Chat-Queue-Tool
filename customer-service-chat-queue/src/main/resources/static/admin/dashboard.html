<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../css/admin-style.css" />
</head>
<body>
<h1>Welcome, Admin</h1>
<div class="dashboard">
    <div class="stats">
        <h2>Queue Monitor</h2>
        <p>VIP Customers in Queue: <span id="vipCount">0</span></p>
        <p>Normal Customers in Queue: <span id="normalCount">0</span></p>
        <p>Waiting Chats: <span id="waitingChats">0</span></p>
        <p>Active Chats: <span id="activeChats">0</span></p>
        <p>Closed Chats: <span id="closedChats">0</span></p>
    </div>

    <div class="agents">
        <h2>Agent Status</h2>
        <ul id="agentList">
            <!-- Dynamically filled -->
        </ul>
    </div>

    <button onclick="logout()">Logout</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        // Role-based access control
        if (!token) {
            alert('Please log in first.');
            window.location.href = '../customer/login.html';
            return;
        }

        if (role !== 'admin') {
            alert('Access denied. Admins only.');
            window.location.href = '../customer/login.html';
            return;
        }

        // Fetch dashboard data
        fetchDashboardData(token);

        // Refresh data every 30 seconds
        setInterval(() => fetchDashboardData(token), 30000);
    });

    function fetchDashboardData(token) {
        // Fetch complete dashboard data
        fetch('http://localhost:8080/customer-service-chat-queue/api/admin/dashboard', {
            headers: { 'Authorization': `Bearer ${token}` },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }
                return response.json();
            })
            .then(data => {
                // Update queue stats
                document.getElementById('vipCount').textContent = data.vipQueue || 0;
                document.getElementById('normalCount').textContent = data.normalQueue || 0;
                document.getElementById('waitingChats').textContent = data.waitingChats || 0;
                document.getElementById('activeChats').textContent = data.inChat || 0;
                document.getElementById('closedChats').textContent = data.closed || 0;

                // Update agent list
                const agentList = document.getElementById('agentList');
                agentList.innerHTML = ''; // Clear previous data

                if (data.agents && data.agents.length > 0) {
                    data.agents.forEach(agent => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                        <strong>${agent.name}</strong> -
                        Status: ${agent.status} -
                        Current Chat: ${agent.currentChat || 'None'} -
                        Today's Chats: ${agent.totalChatsToday}
                    `;
                        agentList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No agents available';
                    agentList.appendChild(li);
                }
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
            });
    }

    function logout() {
        localStorage.clear();
        alert('You have been logged out.');
        window.location.href = '../customer/login.html';
    }
</script>
</body>
</html>